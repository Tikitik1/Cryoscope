<div class="simulador-deshielo" [class.visible]="visible">
  <div class="simulador-header">
    <h3>ğŸ§Š Simulador de Deshielo</h3>
  </div>

  <div class="simulador-content" *ngIf="glaciarSeleccionado">
    
    <!-- Indicador de carga -->
    <div class="loading-indicator" *ngIf="cargandoDatos && !datosListos">
      <div class="loading-spinner"></div>
      <p>ğŸ”„ Cargando datos climÃ¡ticos y de temperatura...</p>
      <small>Esto puede tomar unos segundos...</small>
    </div>
    
    <!-- Estado intermedio - evitar mostrar datos incorrectos -->
    <div class="loading-placeholder" *ngIf="!cargandoDatos && !datosListos">
      <div class="loading-spinner"></div>
      <p>â³ Procesando datos...</p>
    </div>

    <!-- Contenido principal (solo visible cuando los datos estÃ¡n completamente listos) -->
    <div class="contenido-principal" *ngIf="datosListos && !cargandoDatos">
      
      <!-- InformaciÃ³n del glaciar seleccionado -->
      <div class="glaciar-info">
        <h4>ğŸ“ {{ glaciarSeleccionado.nombre }}</h4>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Tipo:</span>
            <span class="value">{{ glaciarSeleccionado.tipo }}</span>
          </div>
          <div class="info-item">
            <span class="label">Volumen:</span>
            <span class="value">{{ glaciarSeleccionado.volumen.toFixed(2) }} kmÂ³</span>
          </div>
          <div class="info-item">
            <span class="label">Ãrea:</span>
            <span class="value">{{ (glaciarSeleccionado.area / 1000000).toFixed(2) }} kmÂ²</span>
          </div>
        </div>
      </div>

      <!-- ParÃ¡metros de simulaciÃ³n -->
      <div class="parametros-simulacion">
        <h5>âš™ï¸ ParÃ¡metros de SimulaciÃ³n</h5>
        
        <!-- Selector de aÃ±o proyectado -->
        <div class="input-group">
          <label for="ano-proyectado">ğŸ“… AÃ±o proyectado:</label>
          <select 
            id="ano-proyectado"
            [(ngModel)]="datosSimulacion.anoProyectado"
            (change)="onSelectAnoChange($event)"
            class="form-input"
            [class.modified]="datosSimulacion.anoProyectado === 'no-especificado'">
            <option value="no-especificado" *ngIf="datosSimulacion.anoProyectado === 'no-especificado'">
              AÃ±o no especificado
            </option>
            <option *ngFor="let ano of anosDisponibles" [value]="ano">
              {{ ano }}
            </option>
          </select>
          <span class="unit" *ngIf="datosModificadosManualmente.size > 0">âš ï¸</span>
        </div>

        <!-- Temperatura base (solo lectura) -->
        <div class="input-group">
          <label for="temp-base">ğŸŒ¡ï¸ Temperatura base del glaciar:</label>
          <input 
            id="temp-base"
            type="number" 
            [(ngModel)]="datosSimulacion.temperaturaBase"
            readonly
            class="form-input readonly"
            step="0.1">
          <span class="unit">Â°C</span>
        </div>

        <!-- DDF -->
        <div class="input-group">
          <label for="ddf">â„ï¸ DDF (Grado-DÃ­a de FusiÃ³n):</label>
          <input 
            id="ddf"
            type="number" 
            [(ngModel)]="datosSimulacion.ddf"
            (input)="onDDFChange($event)"
            step="0.1"
            min="1"
            max="15"
            class="form-input"
            [class.modified]="esParametroModificado('ddf')">
          <span class="unit">mm/Â°CÂ·dÃ­a</span>
          <small class="help-text">VarÃ­a con el aÃ±o proyectado - hielo mÃ¡s dÃ©bil en futuro</small>
        </div>

        <!-- Aumento de temperatura (del delta de temperatura) -->
        <div class="input-group">
          <label for="aumento-temp">ğŸ”º Aumento de temperatura (proyectado):</label>
          <input 
            id="aumento-temp"
            type="number" 
            [(ngModel)]="datosSimulacion.aumentoTemperatura"
            (input)="onAumentoTempChange($event)"
            step="0.1"
            min="0"
            max="10"
            class="form-input"
            [class.modified]="esParametroModificado('aumentoTemperatura')">
          <span class="unit">Â°C</span>
          <small class="help-text">Basado en proyecciones climÃ¡ticas</small>
        </div>

        <!-- RadiaciÃ³n solar -->
        <div class="input-group">
          <label for="radiacion">â˜€ï¸ RadiaciÃ³n solar:</label>
          <input 
            id="radiacion"
            type="number" 
            [(ngModel)]="datosSimulacion.radiacionSolar"
            (input)="onRadiacionChange($event)"
            min="0"
            max="100"
            class="form-input"
            [class.error]="errores['radiacion']"
            [class.modified]="esParametroModificado('radiacionSolar')">
          <span class="unit">%</span>
          <small class="help-text">Aumenta con aÃ±os futuros - menos nubes, mÃ¡s radiaciÃ³n</small>
          <div class="error-message" *ngIf="errores['radiacion']">
            {{ errores['radiacion'] }}
          </div>
        </div>

        <!-- PrecipitaciÃ³n -->
        <div class="input-group">
          <label for="precipitacion">ğŸŒ§ï¸ PrecipitaciÃ³n anual:</label>
          <input 
            id="precipitacion"
            type="number" 
            [(ngModel)]="datosSimulacion.precipitacion"
            (input)="onPrecipitacionChange($event)"
            min="0"
            max="5000"
            class="form-input"
            [class.modified]="esParametroModificado('precipitacion')">
          <span class="unit">mm</span>
          <small class="help-text">Disminuye con aÃ±os futuros - cambio climÃ¡tico reduce lluvias</small>
        </div>

        <!-- Humedad relativa -->
        <div class="input-group">
          <label for="humedad">ğŸ’§ Humedad relativa:</label>
          <input 
            id="humedad"
            type="number" 
            [(ngModel)]="datosSimulacion.humedad"
            (input)="onHumedadChange($event)"
            min="0"
            max="100"
            class="form-input"
            [class.modified]="esParametroModificado('humedad')">
          <span class="unit">%</span>
          <small class="help-text">VarÃ­a con aÃ±os futuros - cambios en patrones atmosfÃ©ricos</small>
        </div>

        <!-- Factor climÃ¡tico -->
        <div class="input-group">
          <label for="clima">ğŸŒ¦ï¸ Clima esperado (factor de ajuste):</label>
          <input 
            id="clima"
            type="number" 
            [(ngModel)]="datosSimulacion.climaEsperado"
            (input)="onClimaEsperadoChange($event)"
            step="0.1"
            min="0.5"
            class="form-input"
            [class.error]="errores['clima']"
            [class.modified]="esParametroModificado('climaEsperado')">
          <small class="help-text">Rango cientÃ­fico: 0.5-5.0 (basado en estudios del IPCC)</small>
          <div class="error-message" *ngIf="errores['clima']">
            {{ errores['clima'] }}
          </div>
        </div>
      </div>

      <!-- Botones de acciÃ³n -->
      <div class="acciones">
        <button class="btn-simular" (click)="simular()">
          ğŸš€ Simular Deshielo
        </button>
        <button class="btn-reset" (click)="resetearParametros()" *ngIf="datosModificadosManualmente.size > 0">
          ğŸ”„ Resetear ParÃ¡metros
        </button>
      </div>

      <!-- Resultados de la simulaciÃ³n -->
      <div class="resultados" *ngIf="resultado">
        <h5>ğŸ“Š Resultados de la SimulaciÃ³n</h5>
        <div class="resultado-principal" [class.critico]="resultado.derretidoCompleto">
          <!-- SIEMPRE mostrar volumen perdido -->
          <div class="resultado-item">
            <span class="label">ğŸ’§ Volumen perdido:</span>
            <span class="value">{{ resultado.volumenPerdido >= 0.01 ? resultado.volumenPerdido.toFixed(3) : resultado.volumenPerdido.toFixed(6) }} kmÂ³</span>
          </div>
          
          <!-- SIEMPRE mostrar nuevo volumen -->
          <div class="resultado-item">
            <span class="label">ğŸ§Š Nuevo volumen:</span>
            <span class="value">{{ resultado.nuevoVolumen >= 0.01 ? resultado.nuevoVolumen.toFixed(3) : resultado.nuevoVolumen.toFixed(6) }} kmÂ³</span>
          </div>

          <div class="resultado-critico" *ngIf="resultado.derretidoCompleto">
            <h6>ğŸš¨ GLACIAR DERRETIDO COMPLETAMENTE</h6>
            <p>El glaciar se derretirÃ­a por completo bajo las condiciones simuladas.</p>
          </div>

          <div class="resultado-item">
            <span class="label">ğŸŒ¡ï¸ Temperatura final:</span>
            <span class="value">{{ resultado.temperaturaFinal.toFixed(1) }}Â°C</span>
          </div>

          <div class="resultado-item">
            <span class="label">ğŸ“ˆ Modificador climÃ¡tico:</span>
            <span class="value">{{ resultado.modificador.toFixed(2) }}</span>
          </div>
        </div>
      </div>

      <!-- Mapa de simulaciÃ³n -->
      <div class="mapa-simulacion" *ngIf="simulacionRealizada">
        <h5>ğŸ—ºï¸ VisualizaciÃ³n del Impacto</h5>
        <div id="mapa-simulacion" class="mapa-container"></div>
        <small class="mapa-help">El mapa muestra la forma real del glaciar y el Ã¡rea de impacto proyectada</small>
      </div>      <!-- AnÃ¡lisis detallado de impactos -->
      <div class="analisis-impactos" *ngIf="resultado && simulacionRealizada && tieneAnalisisImpacto">
        <h5>ğŸ“Š AnÃ¡lisis Detallado de Impactos</h5>
        
        <!-- Resumen visual de impactos con cuadrados de colores -->
        <div class="impactos-grid">
          
          <!-- Impacto Cultural -->
          <div class="impacto-card cultural" 
               [class]="'nivel-' + (resultado.analisisImpacto?.impactoCultural?.nivel || 'bajo')" 
               *ngIf="resultado.analisisImpacto?.impactoCultural">            <div class="card-header">
              <div class="nivel-indicator" [class]="'nivel-' + (resultado.analisisImpacto?.impactoCultural?.nivel || 'bajo')"></div>
              <span class="icon">ğŸ›ï¸</span>
              <h6>Impacto Cultural</h6>
              <span class="nivel-badge">{{ resultado.analisisImpacto?.impactoCultural?.nivel?.toUpperCase() || 'BAJO' }}</span>
            </div>
            <p>{{ resultado.analisisImpacto?.impactoCultural?.descripcion || 'Sin descripciÃ³n disponible' }}</p>            <div class="detalles" *ngIf="resultado.analisisImpacto?.impactoCultural?.comunidadesIndigenas?.length">
              <strong>Comunidades:</strong> {{ getComunidadesIndigenas().slice(0,2).join(', ') }}
              <span *ngIf="getComunidadesIndigenas().length > 2">...</span>
            </div>
            <div class="detalles" *ngIf="resultado.analisisImpacto?.impactoCultural?.sitiosAfectados?.length">
              <strong>Sitios afectados:</strong> {{ resultado.analisisImpacto?.impactoCultural?.sitiosAfectados?.length }} sitios
            </div>          </div>
          
          <!-- Impacto Ambiental -->
          <div class="impacto-card ambiental" 
               [class]="'nivel-' + (resultado.analisisImpacto?.impactoAmbiental?.nivel || 'bajo')" 
               *ngIf="resultado.analisisImpacto?.impactoAmbiental">
            <div class="card-header">
              <div class="nivel-indicator" [class]="'nivel-' + (resultado.analisisImpacto?.impactoAmbiental?.nivel || 'bajo')"></div>
              <span class="icon">ğŸŒ¿</span>
              <h6>Impacto Ambiental</h6>
              <span class="nivel-badge">{{ resultado.analisisImpacto?.impactoAmbiental?.nivel?.toUpperCase() || 'BAJO' }}</span>
            </div>
            <p>{{ resultado.analisisImpacto?.impactoAmbiental?.descripcion || 'Sin descripciÃ³n disponible' }}</p>
            <div class="detalles">
              <strong>Calidad del agua:</strong> {{ resultado.analisisImpacto?.impactoAmbiental?.calidadAgua || 'Sin datos' }}
            </div>
            <div class="detalles" *ngIf="resultado.analisisImpacto?.impactoAmbiental?.especiesEnRiesgo?.length">
              <strong>Especies en riesgo:</strong> {{ getEspeciesEnRiesgo().slice(0,2).join(', ') }}
              <span *ngIf="getEspeciesEnRiesgo().length > 2">...</span>
            </div>
          </div>
          
          <!-- Impacto Urbano -->
          <div class="impacto-card urbano" 
               [class]="'nivel-' + (resultado.analisisImpacto?.impactoUrbano?.nivel || 'bajo')" 
               *ngIf="resultado.analisisImpacto?.impactoUrbano">
            <div class="card-header">
              <div class="nivel-indicator" [class]="'nivel-' + (resultado.analisisImpacto?.impactoUrbano?.nivel || 'bajo')"></div>
              <span class="icon">ğŸ™ï¸</span>
              <h6>Impacto Urbano</h6>
              <span class="nivel-badge">{{ resultado.analisisImpacto?.impactoUrbano?.nivel?.toUpperCase() || 'BAJO' }}</span>
            </div>
            <p>{{ resultado.analisisImpacto?.impactoUrbano?.descripcion || 'Sin descripciÃ³n disponible' }}</p>
            <div class="detalles">
              <strong>PoblaciÃ³n afectada:</strong> {{ (resultado.analisisImpacto?.impactoUrbano?.poblacionAfectada || 0) | number }} hab.
            </div>
            <div class="ciudades-cercanas" *ngIf="getCiudadesCercanas().length > 0">
              <strong>Ciudades cercanas:</strong>
              <div class="ciudad-mini" *ngFor="let ciudad of getCiudadesCercanas().slice(0,3)">
                {{ ciudad?.nombre }} ({{ ciudad?.distancia?.toFixed(0) }}km, {{ ciudad?.poblacion | number }} hab.)
              </div>
            </div>
          </div>        </div>

        <!-- Recomendaciones generales -->
        <div class="recomendaciones" *ngIf="getRecomendaciones().length > 0">
          <h6>ğŸ’¡ Recomendaciones</h6>
          <ul>
            <li *ngFor="let recomendacion of getRecomendaciones().slice(0,5)">
              {{ recomendacion }}
            </li>          </ul>
        </div>
        
        <!-- InformaciÃ³n metodolÃ³gica -->
        <div class="metodologia-analisis">
          <h6>ğŸ”¬ MetodologÃ­a del AnÃ¡lisis</h6>
          <p>AnÃ¡lisis basado en:</p>
          <ul>
            <li><strong>Datos reales:</strong> Ciudades patagÃ³nicas con poblaciones exactas</li>
            <li><strong>GeolocalizaciÃ³n:</strong> Distancias calculadas por proximidad</li>
            <li><strong>Contexto cultural:</strong> Comunidades indÃ­genas histÃ³ricas</li>
            <li><strong>Biodiversidad:</strong> Especies emblemÃ¡ticas (Huemul, CÃ³ndor)</li>
            <li><strong>HidrologÃ­a:</strong> Impacto en calidad del agua</li>
          </ul>
        </div>
      </div>

      <!-- Texto explicativo tÃ©cnico -->
      <div class="explicacion-tecnica" *ngIf="simulacionRealizada">
        <h5>ğŸ“ MetodologÃ­a y Datos</h5>
        <div class="texto-explicativo" [innerHTML]="explicacionSimulacion | nl2br"></div>
      </div>

    </div> <!-- fin contenido-principal -->

  </div>

  <!-- Estado cuando no hay glaciar seleccionado -->
  <div class="sin-glaciar" *ngIf="!glaciarSeleccionado">
    <div class="placeholder">
      <h4>ğŸ”ï¸ Selecciona un glaciar</h4>
      <p>Haz clic en un glaciar en el mapa principal para comenzar la simulaciÃ³n de deshielo.</p>
    </div>
  </div>
</div>
